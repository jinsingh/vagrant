#!/usr/bin/env bash

sqlplus -s <%= scope.function_hiera(["capd-oracle-sys-username"]) %>/<%= scope.function_hiera(["capd-oracle-password-system"]) %>@<%= scope.function_hiera(["capd-oracle-sid"]) %> <<EOF

DECLARE
    user_count number;
    tablespace_count number;
    role_count number;
    
BEGIN

  SELECT COUNT (1) INTO tablespace_count FROM dba_tablespaces WHERE tablespace_name = UPPER ('<%= scope.function_hiera(["capd-oracle-capd-tablespace-name"]) %>');
  IF tablespace_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP TABLESPACE <%= scope.function_hiera(["capd-oracle-capd-tablespace-name"]) %> INCLUDING CONTENTS AND DATAFILES';
  END IF;

  SELECT COUNT (1) INTO tablespace_count FROM dba_tablespaces WHERE tablespace_name = UPPER ('<%= scope.function_hiera(["capd-oracle-capd-auth-tablespace-name"]) %>');
  IF tablespace_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP TABLESPACE <%= scope.function_hiera(["capd-oracle-capd-auth-tablespace-name"]) %> INCLUDING CONTENTS AND DATAFILES';
  END IF;

  SELECT COUNT (1) INTO tablespace_count FROM dba_tablespaces WHERE tablespace_name = UPPER ('<%= scope.function_hiera(["capd-oracle-capd-audit-tablespace-name"]) %>');
  IF tablespace_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP TABLESPACE <%= scope.function_hiera(["capd-oracle-capd-audit-tablespace-name"]) %> INCLUDING CONTENTS AND DATAFILES';
  END IF;

  SELECT COUNT (1) INTO role_count FROM dba_roles WHERE role = UPPER ('<%= scope.function_hiera(["capd-oracle-capd-standard-role-name"]) %>');
  IF role_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP ROLE <%= scope.function_hiera(["capd-oracle-capd-standard-role-name"]) %>';
  END IF;

  SELECT COUNT (1) INTO role_count FROM dba_roles WHERE role = UPPER ('<%= scope.function_hiera(["capd-oracle-capd-audit-role-name"]) %>');
  IF role_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP ROLE <%= scope.function_hiera(["capd-oracle-capd-audit-role-name"]) %>';
  END IF;

  FOR connections IN (select sid, serial# from V\$session where username = '<%= scope.function_hiera(["capd-oracle-username"]) %>')
  LOOP
      execute immediate 'Alter System Kill Session '''|| connections.sid || ',' || connections.serial# || ''' IMMEDIATE';
  END LOOP;

  FOR connections IN (select sid, serial# from V\$session where username = '<%= scope.function_hiera(["capd-oracle-auth-username"]) %>')
  LOOP
      execute immediate 'Alter System Kill Session '''|| connections.sid || ',' || connections.serial# || ''' IMMEDIATE';
  END LOOP;

  FOR connections IN (select sid, serial# from V\$session where username = '<%= scope.function_hiera(["capd-oracle-audit-username"]) %>')
  LOOP
      execute immediate 'Alter System Kill Session '''|| connections.sid || ',' || connections.serial# || ''' IMMEDIATE';
  END LOOP;
  
  SELECT COUNT (1) INTO user_count FROM dba_users WHERE username = UPPER ('<%= scope.function_hiera(["capd-oracle-username"]) %>');

  IF user_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP USER <%= scope.function_hiera(["capd-oracle-username"]) %> CASCADE';
  END IF;
  
    SELECT COUNT (1) INTO user_count FROM dba_users WHERE username = UPPER ('<%= scope.function_hiera(["capd-oracle-auth-username"]) %>');

  IF user_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP USER <%= scope.function_hiera(["capd-oracle-auth-username"]) %> CASCADE';
  END IF;
  
    SELECT COUNT (1) INTO user_count FROM dba_users WHERE username = UPPER ('<%= scope.function_hiera(["capd-oracle-audit-username"]) %>');

  IF user_count != 0
  THEN
    EXECUTE IMMEDIATE 'DROP USER <%= scope.function_hiera(["capd-oracle-audit-username"]) %> CASCADE';
  END IF;
END;
/

quit
EOF
